# Zmac Assembler Support in DeZog

This document describes how to use Zmac assembler support in the DeZog VS Code Z80 debugger extension.

## Overview

Zmac is a Z80 macro assembler that outputs `.bds` (Binary Debuggable Source) files containing debug information including:
- Source file mapping
- Label definitions  
- Binary data locations
- Symbol usage information

DeZog now supports loading debug information from Zmac `.bds` files, enabling full source-level debugging for Zmac-assembled programs.

## Configuration

### Basic Configuration

Add a `zmac` section to your `launch.json` configuration:

```json
{
    "type": "dezog",
    "request": "launch", 
    "name": "My Z80 Program",
    "remoteType": "your_emulator_type",
    "zmac": [
        {
            "path": "path/to/your/program.bds"
        }
    ]
}
```

### Advanced Configuration

You can configure multiple BDS files and additional options:

```json
{
    "zmac": [
        {
            "path": "main.bds",
            "srcDirs": ["src/", "include/"],
            "excludeFiles": ["temp.asm", "debug_*.asm"]
        },
        {
            "path": "library.bds",
            "srcDirs": ["lib/"]
        }
    ]
}
```

#### Configuration Options

- **`path`** (required): Path to the `.bds` file
- **`srcDirs`** (optional): Array of directories to search for source files
- **`excludeFiles`** (optional): Array of file patterns to exclude from processing

### TRS-80 Example Configuration

For TRS-80 development with Zmac:

```json
{
    "version": "0.2.0",
    "configurations": [
        {
            "type": "dezog",
            "request": "launch",
            "name": "TRS-80 Zmac Debug",
            "remoteType": "trs80",
            "trs80": {
                "hostname": "localhost",
                "port": 49152
            },
            "zmac": [
                {
                    "path": "build/program.bds",
                    "srcDirs": ["src/", "include/"]
                }
            ],
            "startAutomatically": false,
            "rootFolder": "${workspaceFolder}",
            "topOfStack": "0x8000"
        }
    ]
}
```

## BDS File Format

The `.bds` file format contains the following record types:

- **`f`** - File reference: Maps file IDs to source file paths
- **`s`** - Source/Label: Associates labels with memory addresses and source locations  
- **`d`** - Binary data: Contains the actual machine code bytes
- **`u`** - Usage: Lists where each label is referenced

Example BDS content:
```
f1 hello.asm
f2 system.inc
s1 4200 1 start
s2 4203 2 msg_loop
d1 4200 CD104221324300
d2 4203 7E23B7280FCD1042C9
u1 start 4200
u2 msg_loop 4203 4206
```

## Workflow

1. **Assemble with Zmac**: Generate your `.bds` file using Zmac
   ```bash
   zmac program.asm --debug
   ```

2. **Configure DeZog**: Add the zmac configuration to your `launch.json`

3. **Start Debugging**: Launch your debugging session - DeZog will automatically:
   - Parse the BDS file
   - Load symbol information
   - Map source files to memory addresses
   - Enable breakpoints on source lines

## Features Supported

- ✅ **Symbol Resolution**: All labels from BDS files are available for inspection
- ✅ **Source Mapping**: Breakpoints can be set on source lines
- ✅ **Memory Mapping**: Binary data is mapped to source locations
- ✅ **Multi-file Support**: Multiple BDS files can be loaded simultaneously
- ✅ **Usage Tracking**: Symbol usage information is preserved

## Emulator Compatibility

Zmac support works with any emulator that DeZog supports, including:
- TRS-80GP
- ZEsarUX
- MAME
- Custom emulators via remote protocol

## Troubleshooting

### BDS File Not Found
- Verify the path in your configuration is correct
- Use absolute paths or paths relative to the workspace root
- Check that Zmac generated the BDS file with debug information

### Symbols Not Loading
- Ensure your BDS file contains 's' (source) records
- Check that source files exist in the specified directories
- Verify file permissions allow reading the BDS file

### Source Mapping Issues
- Check that `srcDirs` includes all directories containing source files
- Ensure source file paths in the BDS file are correct
- Verify that source files haven't been moved since assembly

## Example Project Structure

```
my-z80-project/
├── src/
│   ├── main.asm
│   └── utils.asm
├── include/
│   └── system.inc
├── build/
│   ├── main.bds      # Generated by Zmac
│   └── main.bin
├── .vscode/
│   └── launch.json   # DeZog configuration
└── Makefile
```

With this structure, your configuration would be:

```json
{
    "zmac": [
        {
            "path": "build/main.bds",
            "srcDirs": ["src/", "include/"]
        }
    ]
}
```

## Benefits of Zmac Integration

- **Source-level debugging**: Set breakpoints directly in your assembly source
- **Symbol inspection**: View label values and memory contents by name
- **Accurate mapping**: Precise correlation between source and machine code
- **Multi-file support**: Debug complex projects with multiple source files
- **Standard format**: Uses Zmac's native debug format without conversion
